<div class="sidebar-layout">
  <app-sidebar></app-sidebar>

  <div class="container">
    <app-header></app-header>

    @if (isLoading) {
      <app-loading
        [overlay]="true"
        message="Carregando hist√≥rico"
        size="large">
      </app-loading>
    }

    @if (!isLoading) {
      <div class="historico-content">
        <div class="header">
          <h1>üìä Hist√≥rico de Simulados</h1>
          <p>Veja seus resultados anteriores</p>
        </div>
        @if (errorMessage && historico.length === 0) {
          <div class="empty-state">
            <span class="material-icons empty-icon">history</span>
            <p>{{ errorMessage }}</p>
            <button mat-flat-button color="primary" routerLink="/enem">Fazer um Simulado ENEM</button>
            <button mat-stroked-button color="accent" routerLink="/generativa" style="margin-top: 10px;">Gerar Quest√µes</button>
          </div>
        }
        @if (historico.length > 0) {
          <div class="historico-list">
            <div class="historico-header">
              <div class="col-data">Data</div>
              <div class="col-obs col-obs-header">
                <span>Descri√ß√£o</span>
                @if (!isEditMode) {
                  <button
                    mat-icon-button
                    (click)="toggleEditMode(true)"
                    class="edit-button-header"
                    aria-label="Ativar modo de edi√ß√£o">
                    <span class="material-icons">edit</span>
                  </button>
                }
                @if (isEditMode) {
                  <button
                    mat-stroked-button
                    color="primary"
                    (click)="toggleEditMode(false)"
                    class="edit-button-header done-button"
                    aria-label="Sair do modo de edi√ß√£o">
                    Conclu√≠do
                  </button>
                }
              </div>
              <div class="col-pontuacao">Pontua√ß√£o</div>
            </div>
            @for (item of historico; track item) {
              <div class="historico-item">
                <div class="col-data">{{ formatDate(item.dataHora) }}</div>
                <div class="col-obs">
                  @if (editingId !== item.id) {
                    <span
                      (click)="isEditMode ? startEdit(item) : null"
                      [class.editable-text]="isEditMode">
                      {{ item.observacoes || 'Simulado' }}
                    </span>
                  }
                  @if (isEditMode && editingId === item.id) {
                    <div class="edit-container">
                      <input
                        [(ngModel)]="editText"
                        (keyup.enter)="saveEdit(item.id)"
                        (keyup.escape)="cancelEdit()"
                        placeholder="Digite a descri√ß√£o"
                        class="edit-input">
                      <button mat-icon-button color="primary" (click)="saveEdit(item.id)" aria-label="Salvar">
                        <span class="material-icons">check</span>
                      </button>
                      <button mat-icon-button (click)="cancelEdit()" aria-label="Cancelar">
                        <span class="material-icons">close</span>
                      </button>
                      <button mat-icon-button color="warn" (click)="deleteItem(item.id)" aria-label="Excluir">
                        <span class="material-icons">delete</span>
                      </button>
                    </div>
                  }
                </div>
                <div class="col-pontuacao"
               [ngClass]="{
                 'score-high': item.pontuacao >= 70,
                 'score-medium': item.pontuacao >= 50 && item.pontuacao < 70,
                 'score-low': item.pontuacao < 50
               }">
                  {{ (item.pontuacao || 0).toFixed(1) }}%
                  @if (item.acertos !== null && item.totalQuestoes !== null) {
                    <span class="acertos-detalhe">
                      ({{ item.acertos }} / {{ item.totalQuestoes }})
                    </span>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    }

  </div>
</div>
